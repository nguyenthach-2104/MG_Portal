<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt Lại Mật Khẩu - MG Bình Dương</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="config.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        
        .button-loading::after { 
            content: ''; 
            display: inline-block; 
            width: 16px; 
            height: 16px; 
            border: 2px solid transparent; 
            border-top-color: white;
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin-left: 10px; 
        }
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }

        #popup-message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
            font-weight: 500;
            z-index: 1000;
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
            transform: translateX(120%);
            opacity: 0;
        }
        #popup-message-box.show {
            transform: translateX(0);
            opacity: 1;
        }
        #popup-message-box.success { background-color: #28a745; } /* Màu xanh lá cây đậm hơn */
        #popup-message-box.error { background-color: #dc3545; } /* Màu đỏ đậm hơn */
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-md mx-auto">
        <div class="bg-white p-8 rounded-xl shadow-lg">
            <h1 class="text-2xl font-bold text-center mb-1">Tạo mật khẩu mới</h1>
            <p class="text-center text-gray-500 mb-6">Mật khẩu mới của bạn phải có ít nhất 6 ký tự.</p>
            
            <form id="reset-form" class="hidden">
                <div class="mb-4">
                    <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu mới</label>
                    <input type="password" id="new-password" name="new-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div class="mb-5">
                    <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Xác nhận mật khẩu</label>
                    <input type="password" id="confirm-password" name="confirm-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <button type="submit" id="reset-button" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center justify-center h-10 transition-colors">
                    Lưu Mật khẩu
                </button>
            </form>

            <div id="inline-message-area" class="text-center mt-4 text-sm"></div>
        </div>
    </div>

    <div id="popup-message-box">
        <p id="popup-message-text"></p>
    </div>

    <script>
    const resetForm = document.getElementById('reset-form');
    const resetButton = document.getElementById('reset-button');
    const newPasswordInput = document.getElementById('new-password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const inlineMessageArea = document.getElementById('inline-message-area');
    const popupMessageBox = document.getElementById('popup-message-box');
    const popupMessageText = document.getElementById('popup-message-text');
    let token = '';

    function showInlineMessage(message, isError = false) {
        inlineMessageArea.textContent = message;
        inlineMessageArea.className = `text-center mt-4 text-sm ${isError ? 'text-red-600' : 'text-green-600'}`;
    }

    function showPopupMessage(message, isSuccess = true) {
        popupMessageText.textContent = message;
        popupMessageBox.className = ``;
        popupMessageBox.classList.add(isSuccess ? 'success' : 'error', 'show');
        setTimeout(() => {
            popupMessageBox.classList.remove('show');
        }, 4000);
    }

    function setLoading(button, isLoading) {
        if (isLoading) {
            button.disabled = true;
            button.classList.add('button-loading', 'opacity-80');
            button.innerHTML = '<span>Đang xử lý</span>';
        } else {
            button.disabled = false;
            button.classList.remove('button-loading', 'opacity-80');
            button.textContent = 'Lưu Mật khẩu';
        }
    }
    
    function validatePasswords() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        if (confirmPassword === '') {
             showInlineMessage('');
             return true;
        }
        if (newPassword !== confirmPassword) {
            showInlineMessage('Mật khẩu xác nhận không khớp.', true);
            return false;
        } else {
            showInlineMessage('Mật khẩu đã khớp!', false);
            return true;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        token = params.get('token');
        if (token) {
            resetForm.classList.remove('hidden');
        } else {
            showInlineMessage('Lỗi: Không tìm thấy mã token hợp lệ. Vui lòng yêu cầu đặt lại mật khẩu mới.', true);
        }
    });

    newPasswordInput.addEventListener('input', validatePasswords);
    confirmPasswordInput.addEventListener('input', validatePasswords);

    resetForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPassword = newPasswordInput.value;

        if (newPassword.length < 6) {
            showInlineMessage('Mật khẩu phải có ít nhất 6 ký tự.', true);
            return;
        }
        
        if (!validatePasswords()) {
            return;
        }

        const payload = { action: 'resetPassword', token: token, newPassword: newPassword };
        
        setLoading(resetButton, true);
        const result = await handleApiRequest(payload);
        setLoading(resetButton, false);

        // --- SỬA LỖI TẠI ĐÂY ---
        // Kiểm tra đúng cấu trúc dữ liệu lồng nhau mà server trả về
        if (result && result.data && result.data.success) {
            // Vô hiệu hóa toàn bộ form để ngăn chặn mọi tương tác không mong muốn
            newPasswordInput.disabled = true;
            confirmPasswordInput.disabled = true;
            resetButton.disabled = true;
            
            // Xóa thông báo inline và ẩn form đi cho trực quan
            showInlineMessage(''); // Xóa mọi thông báo cũ
            resetForm.classList.add('hidden');
            
            // Hiển thị thông báo thành công dạng popup
            showPopupMessage(result.data.message || 'Mật khẩu đã được cập nhật thành công!', true);
            
            // Chuyển hướng về trang đăng nhập sau 3 giây
            setTimeout(() => {
                window.location.href = 'index.html'; 
            }, 3000);
        } else {
            // Lấy message lỗi từ result.data.message hoặc dùng thông báo mặc định
            const errorMessage = result?.data?.message || 'Yêu cầu thất bại, vui lòng thử lại.';
            showPopupMessage(errorMessage, false);
        }
    });

    async function handleApiRequest(payload) {
        if (typeof APPS_SCRIPT_URL === 'undefined' || !APPS_SCRIPT_URL) {
            showPopupMessage('Lỗi cấu hình: Không tìm thấy URL của API.', false);
            return null;
        }
        return new Promise((resolve) => {
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            let script; 

            window[callbackName] = (response) => {
                delete window[callbackName];
                document.body.removeChild(script);
                resolve(response);
            };
            
            script = document.createElement('script'); 
            
            script.onerror = () => {
                 delete window[callbackName];
                 document.body.removeChild(script);
                 resolve({ 
                     status: 'ERROR', 
                     data: { 
                         success: false, 
                         message: 'Lỗi mạng hoặc không thể kết nối tới máy chủ.' 
                     } 
                 });
            };

            const params = new URLSearchParams({ ...payload, callback: callbackName });
            script.src = `${APPS_SCRIPT_URL}?${params.toString()}`;
            document.body.appendChild(script);
        });
    }
</script>
</body>
</html>