<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MG Bình Dương - Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- IMPORTANT: Bạn cần tạo file config.js và đặt URL của Apps Script vào đó -->
    <!-- Ví dụ nội dung file config.js: -->
    <!-- const APPS_SCRIPT_URL = "URL_WEB_APP_CỦA_BẠN"; -->
    <script src="config.js"></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .button-loading::after { 
            content: ''; 
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        .lightswipe {
            position: relative;
            display: inline-block;
            overflow: hidden;
            -webkit-mask-image: -webkit-radial-gradient(white, black);
        }
        .lightswipe::after {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            width: 70%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.7), transparent);
            transform: skewX(-25deg);
            animation: lightswipe-effect 4s infinite linear;
        }
        @keyframes lightswipe-effect {
            100% {
                left: 150%;
            }
        }
    </style>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
</head>
<body class="flex flex-col min-h-screen">

    <main class="flex-grow flex items-center justify-center p-4">
        <div id="app" class="w-full max-w-md mx-auto">
            <div id="login-screen">
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <div class="text-center mb-6">
                        <span class="text-3xl font-bold text-red-600">MG</span>
                        <span class="text-3xl font-bold text-gray-700">Bình Dương</span>
                    </div>
                    <h1 class="text-2xl font-bold text-center mb-1">Chào mừng trở lại!</h1>
                    <p class="text-center text-gray-500 mb-6">Đăng nhập vào hệ thống quản lý.</p>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Tên đăng nhập</label>
                            <input type="text" id="username" name="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div class="mb-5">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label>
                            <input type="password" id="password" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <button type="submit" id="login-button" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center justify-center h-10 transition-colors">
                            Đăng nhập
                        </button>
                        <div class="text-center mt-4">
                            <a href="#" id="forgot-password-link" class="text-sm text-blue-600 hover:underline">Quên mật khẩu?</a>
                        </div>
                    </form>
                </div>

                <!-- === KHU VỰC LOG LỖI MỚI === -->
                <div id="log-container" class="mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative hidden">
                    <strong class="font-bold">Nhật ký lỗi:</strong>
                    <span class="block sm:inline" id="log-message"></span>
                </div>

            </div>
        </div>
    </main>
    
    <div id="message-box" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-[120%] transition-transform duration-300">
        <p id="message-text"></p>
    </div>

    <footer class="text-center py-4 text-sm text-gray-600 bg-transparent">
        <p class="mb-1 flex justify-center items-baseline">
            <span>Bản quyền © 2025&nbsp;</span>
            <span class="lightswipe">Thạch Tech.</span>
        </p>
        <p>Hỗ trợ kỹ thuật liên hệ <a href="https://zalo.me/0888466060" target="_blank" rel="noopener noreferrer" class="font-medium text-blue-600 hover:underline">0888.46.6060</a></p>
    </footer>

    <script>
    // --- DOM Elements ---
    const loginForm = document.getElementById('login-form');
    const loginButton = document.getElementById('login-button');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const forgotPasswordLink = document.getElementById('forgot-password-link');
    const logContainer = document.getElementById('log-container'); // Mới: Lấy phần tử log
    const logMessage = document.getElementById('log-message');   // Mới: Lấy phần tử chứa tin nhắn log

    // --- Utility Functions ---
    function showToast(message, isSuccess = true) {
        messageText.textContent = message;
        messageBox.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition-transform duration-300 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
        messageBox.classList.remove('translate-x-[120%]');
        setTimeout(() => { messageBox.classList.add('translate-x-[120%]'); }, 4000);
    }
    
    // Mới: Hàm hiển thị log lỗi chi tiết trên trang
    function displayLogError(message) {
        logMessage.textContent = message;
        logContainer.classList.remove('hidden');
    }

    function setButtonLoading(button, isLoading, defaultHtml) {
        if (isLoading) {
            button.disabled = true;
            button.classList.add('button-loading', 'opacity-80');
            button.innerHTML = 'Đang xử lý...';
        } else {
            button.disabled = false;
            button.classList.remove('button-loading', 'opacity-80');
            button.innerHTML = defaultHtml;
        }
    }

    // --- Main Login Logic ---
    function handleLogin() {
        const originalBtnHtml = loginButton.innerHTML;
        setButtonLoading(loginButton, true, originalBtnHtml);
        logContainer.classList.add('hidden'); // Ẩn log cũ khi bắt đầu đăng nhập

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
            const msg = "Vui lòng nhập đủ Tên đăng nhập và Mật khẩu.";
            showToast(msg, false);
            displayLogError(msg); // Hiển thị cả trong log
            setButtonLoading(loginButton, false, originalBtnHtml);
            return;
        }

        try {
            const params = new URLSearchParams({
                action: 'checkUser',
                username: username, // Gửi username nguyên bản, server sẽ xử lý toLowerCase
                password: password,
                callback: 'handleLoginResponse'
            });

            const script = document.createElement('script');
            // Đảm bảo biến APPS_SCRIPT_URL đã được định nghĩa trong config.js
            script.src = `${APPS_SCRIPT_URL}?${params.toString()}`;

            window.handleLoginResponse = (result) => {
                setButtonLoading(loginButton, false, originalBtnHtml);
                
                // Cải tiến: Lấy thông báo lỗi chi tiết từ server
                const serverMessage = result.data ? result.data.message : (result.message || "Lỗi không xác định.");

                if (result.status === 'SUCCESS' && result.data.isValid) {
                    showToast("Đăng nhập thành công!", true);
                    sessionStorage.setItem('loggedInUser', JSON.stringify(result.data.userInfo));
                    
                    const user = result.data.userInfo;
                    const userDepartment = (user.department || '').trim().toLowerCase(); 

                    if (userDepartment === 'quản lý' || userDepartment.startsWith('m-')) {
                        window.location.href = 'quanly.html';
                    } else {
                        window.location.href = 'homepage.html';
                    }
                } else {
                    // Hiển thị thông báo lỗi chi tiết từ server
                    showToast(serverMessage, false);
                    displayLogError(`Server trả về: ${serverMessage}`);
                }
                document.body.removeChild(script);
                delete window.handleLoginResponse;
            };

            script.onerror = () => { 
                const msg = "Lỗi kết nối đến máy chủ. Kiểm tra lại URL trong config.js hoặc tình trạng mạng.";
                showToast(msg, false);
                displayLogError(msg);
                setButtonLoading(loginButton, false, originalBtnHtml);
                if (window.handleLoginResponse) delete window.handleLoginResponse;
            };
            document.body.appendChild(script);

        } catch (error) {
            const msg = `Lỗi phía client: ${error.message}`;
            showToast(msg, false);
            displayLogError(msg);
            setButtonLoading(loginButton, false, originalBtnHtml);
        }
    }

    // --- Logic xử lý quên mật khẩu (Giữ nguyên) ---
    function handleForgotPassword() {
        const usernameInput = prompt("Vui lòng nhập Tên đăng nhập (username) của bạn để khôi phục mật khẩu:");

        if (!usernameInput || usernameInput.trim() === '') {
            return;
        }
        
        const username = usernameInput.trim();
        showToast("Đang gửi yêu cầu, vui lòng chờ...", true);

        try {
            const params = new URLSearchParams({
                action: 'forgotPassword',
                username: username,
                callback: 'handleForgotResponse'
            });

            const script = document.createElement('script');
            script.src = `${APPS_SCRIPT_URL}?${params.toString()}`;

            window.handleForgotResponse = (result) => {
                const serverMessage = result.data ? result.data.message : "Có lỗi xảy ra.";
                const isSuccess = result.status === 'SUCCESS' && result.data.success;
                showToast(serverMessage, isSuccess);
                if(!isSuccess) displayLogError(`Quên mật khẩu: ${serverMessage}`);

                document.body.removeChild(script);
                delete window.handleForgotResponse;
            };

            script.onerror = () => { 
                const msg = "Lỗi kết nối đến máy chủ khi yêu cầu quên mật khẩu.";
                showToast(msg, false);
                displayLogError(msg);
            };
            document.body.appendChild(script);

        } catch (error) {
            const msg = `Đã xảy ra lỗi: ${error.message}`;
            showToast(msg, false);
            displayLogError(msg);
        }
    }


    // --- Event Listeners ---
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        handleLogin();
    });

    forgotPasswordLink.addEventListener('click', (e) => {
        e.preventDefault(); 
        handleForgotPassword();
    });


    document.addEventListener('DOMContentLoaded', () => {
        if (sessionStorage.getItem('loggedInUser')) {
            const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const userDepartment = (user.department || '').trim().toLowerCase();

             if (userDepartment === 'quản lý' || userDepartment.startsWith('m-')) {
                window.location.href = 'quanly.html';
            } else {
                window.location.href = 'homepage.html';
            }
        }
    });
</script>
</body>
</html>
